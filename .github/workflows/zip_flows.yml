name: zip_flows

on:
  workflow_dispatch:
  push:
    paths:
      - '_worker.js'

permissions:
  contents: write

jobs:
  package-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (clean)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: Ensure no leftover zip
        run: |
          if [ -f "_worker.js.zip" ]; then
            git checkout -- _worker.js.zip || rm -f _worker.js.zip
          fi

      - name: Zip the worker file
        run: zip -q _worker.js.zip _worker.js

      - name: Commit and push the packaged file
        uses: EndBug/add-and-commit@v7
        with:
          add: '_worker.js.zip'
          message: 'Automatically package and commit _worker.js.zip'
          author_name: github-actions[bot]
          author_email: actions[bot]@users.noreply.github.com
          token: ${{ secrets.GH_TOKEN }}
