name: zip_flows

on:
  workflow_dispatch:
  push:
    paths:
      - '_worker.js'

permissions:
  contents: write

jobs:
  package-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (clean)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: Ensure branch matches remote and workspace is pristine
        run: |
          # Make sure we are on the correct branch and match remote
          git fetch origin
          git checkout "${{ github.ref_name }}" || true
          git reset --hard "origin/${{ github.ref_name }}" || true
          git clean -fdx

      - name: Discard or remove any existing _worker.js.zip
        run: |
          # Try to discard local changes to the tracked file; if that fails remove it
          if git ls-files --error-unmatch _worker.js.zip >/dev/null 2>&1; then
            git checkout -- _worker.js.zip || git rm -f --ignore-unmatch _worker.js.zip || true
          else
            rm -f _worker.js.zip || true
          fi

      - name: Zip the worker file
        run: |
          zip -q _worker.js.zip _worker.js

      - name: Commit and push the packaged file
        uses: EndBug/add-and-commit@v7
        with:
          add: '_worker.js.zip'
          message: 'Automatically package and commit _worker.js.zip'
          author_name: github-actions[bot]
          author_email: actions[bot]@users.noreply.github.com
          token: ${{ secrets.GITHUB_TOKEN }}
